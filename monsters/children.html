<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å­©å­è³‡æ–™ç®¡ç†ï½œå°æ€ªç¸æŒ‘æˆ°ç‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      background: #FFFDF6;
      font-family: Arial, sans-serif;
      padding: 16px;
    }

    h1 {
      color: #C68A56;
      text-align: center;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #777;
      margin-bottom: 16px;
    }

    .navbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #C68A56;
      background: #FFF4C8;
      font-size: 14px;
      text-decoration: none;
      color: #5A3B24;
    }

    .nav-btn.active {
      background: #C68A56;
      color: white;
      font-weight: bold;
    }

    .layout {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
      .col {
        flex: 1;
      }
    }

    .panel {
      background: #FFFFFF;
      border-radius: 12px;
      border: 2px solid #C68A56;
      padding: 16px;
      margin-bottom: 8px;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #5A3B24;
    }

    .panel p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #666;
    }

    .current-child {
      font-size: 14px;
      color: #5A3B24;
      padding: 8px 10px;
      border-radius: 8px;
      background: #FFF8DC;
      border: 1px dashed #C68A56;
      margin-top: 4px;
    }

    .hint {
      font-size: 12px;
      color: #888;
    }

    /* å­åˆ—è¡¨å¡ç‰‡ */
    .child-card {
      border-radius: 10px;
      border: 1px solid #E0C7A0;
      padding: 10px;
      margin-bottom: 8px;
      background: #FFFAED;
      font-size: 14px;
      transition: all 0.2s;
    }

    .child-card.active-child {
        border-color: #FFC857;
        box-shadow: 0 0 0 2px #FFC857;
        background: #FFFEF5;
    }

    .child-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .child-name {
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .child-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #FFC857;
      color: #5A3B24;
    }

    .child-meta {
      font-size: 12px;
      color: #555;
      margin-top: 2px;
    }

    .child-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      margin-top: 6px;
    }

    button {
      padding: 6px 12px;
      background: #FFE680;
      border: none;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button.small {
      font-size: 12px;
      padding: 4px 10px;
    }

    button.danger {
      background: #F4B0A8;
    }

    button.primary {
      background: #FFC857;
    }
    
    button:hover:not(:disabled) {
      background: #FFD966;
    }

    /* è¡¨å–® */
    .form-row {
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
      color: #5A3B24;
    }

    input[type="text"],
    input[type="date"] {
      width: 100%;
      box-sizing: border-box;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #C68A56;
      font-size: 14px;
      background: #FFFCF4;
    }

    .edit-indicator {
      font-size: 12px;
      color: #B35B3E;
      margin-bottom: 8px;
    }

    .error-message {
      font-size: 13px;
      color: #C0392B;
      margin-top: 4px;
      min-height: 18px;
    }

    .info-message {
      font-size: 13px;
      color: #5A3B24;
      margin-top: 4px;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 22px;
      border-radius: 20px;
      font-size: 15px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- å°è¦½åˆ—ï¼šå¤šä¸€å€‹ã€Œå­©å­è³‡æ–™ã€ -->
  <div class="navbar">
    <a href="index.html" class="nav-btn">é¦–é </a>
    <a href="dashboard.html" class="nav-btn">ä»Šæ—¥ä»»å‹™</a>
    <a href="setting.html" class="nav-btn">ä»»å‹™è¨­å®š</a>
    <a href="rewards.html" class="nav-btn">çå‹µå•†åŸ</a>
    <a href="monsters.html" class="nav-btn">å°æ€ªç¸æ£®æ—</a>
    <a href="story.html" class="nav-btn">æŒ‘æˆ°ç‹æ•…äº‹</a>
    <a href="children.html" class="nav-btn active">å­©å­è³‡æ–™</a>
  </div>

  <h1>å­©å­è³‡æ–™ç®¡ç†</h1>
  <div class="subtitle">å»ºç«‹æ¯ä¸€ä½å°æ€ªç¸çš„åŸºæœ¬è³‡æ–™ï¼Œä¹‹å¾Œçš„ä»»å‹™èˆ‡é»æ•¸ç´€éŒ„éƒ½æœƒè·Ÿå­©å­ç¶å®šã€‚</div>

  <div class="layout">
    <!-- å·¦ï¼šç›®å‰å­©å­åˆ—è¡¨ -->
    <div class="col">
      <div class="panel" id="children-list-panel">
        <h2>ç›®å‰å­©å­</h2>
        <p>ä¸€ä½çˆ¸åª½å¯ä»¥å»ºç«‹å¤šä½å­©å­ï¼Œä»»å‹™èˆ‡é»æ•¸æœƒä¾ç…§å­©å­åˆ†é–‹è¨ˆç®—ã€‚</p>

        <div id="current-child-info" class="current-child">
          ç›®å‰æ²’æœ‰é¸æ“‡çš„å­©å­ï¼Œè«‹å¾ä¸‹æ–¹æ¸…å–®é¸æ“‡ã€Œè¨­ç‚ºç›®å‰å°æ€ªç¸ã€ã€‚
        </div>

        <div id="children-list" style="margin-top:12px;"></div>
      </div>
    </div>

    <!-- å³ï¼šæ–°å¢ / ç·¨è¼¯å­©å­ -->
    <div class="col">
      <div class="panel" id="edit-section">
        <h2>æ–°å¢ / ç·¨è¼¯å­©å­è³‡æ–™</h2>
        <p>è‡³å°‘éœ€è¦å¡«å¯«ã€Œå­©å­åå­—ã€ï¼Œæš±ç¨±èˆ‡ç”Ÿæ—¥å¯ä»¥ä¹‹å¾Œå†è£œä¸Šã€‚</p>

        <div id="edit-indicator" class="edit-indicator" style="display:none;"></div>

        <div class="form-row">
          <label for="child-name">å­©å­åå­—ï¼ˆå¿…å¡«ï¼‰</label>
          <input id="child-name" type="text" placeholder="ä¾‹å¦‚ï¼šå°å®‰ã€å°æ¨‚ã€æ²›æ²›" />
        </div>

        <div class="form-row">
          <label for="child-nickname">æš±ç¨±ï¼ˆé¸å¡«ï¼Œå­©å­çœ‹åˆ°çš„åå­—ï¼‰</label>
          <input id="child-nickname" type="text" placeholder="ä¾‹å¦‚ï¼šå‹‡æ•¢å°æˆ°å£«ã€æ£®æ—æ¢éšªå®¶" />
          <div class="hint">ä¹‹å¾Œåœ¨ä»»å‹™é å¯ä»¥ç”¨æš±ç¨±å’Œå­©å­èªªè©±ï¼Œæ›´æœ‰ä»£å…¥æ„Ÿã€‚</div>
        </div>

        <div class="form-row">
          <label for="child-birthday">ç”Ÿæ—¥ï¼ˆé¸å¡«ï¼‰</label>
          <input id="child-birthday" type="date" />
        </div>

        <div class="form-row" style="display:flex; gap:8px; margin-top:4px;">
          <button id="btn-save-child" class="primary">ï¼‹ æ–°å¢å­©å­</button>
          <button id="btn-cancel-edit" type="button" class="small" style="display:none;">å–æ¶ˆç·¨è¼¯</button>
        </div>

        <div id="form-error" class="error-message"></div>
        <div id="form-info" class="info-message"></div>
      </div>
    </div>
  </div>

  <!-- Toast æç¤º -->
  <div id="toast" class="toast hidden">å·²å„²å­˜</div>

  <!-- Supabase JS -->
  <script src="[https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2](https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2)"></script>
  <script>
    // çµ±ä¸€çš„ Supabase è¨­å®š (ä½¿ç”¨æ‚¨ login.html ä¸­çš„çœŸå¯¦é‡‘é‘°)
    const SUPABASE_URL = "[https://reunrobejvodzkhbtspp.supabase.co](https://reunrobejvodzkhbtspp.supabase.co)";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJldW5yb2JlanZvZHpraGJ0c3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMzc1MDEsImV4cCI6MjA3OTgxMzUwMX0.4Tfa94upcxp2wfnBUwBtFJl7H1NdnY3uQxLRxnjBrRE";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ACTIVE_CHILD_KEY = "monsters_active_child_id"; // å„²å­˜æ´»èºå­©å­ ID
    
    let currentUser = null;
    let children = [];
    let editingChildId = null;

    const childrenListEl = document.getElementById("children-list");
    const currentChildInfoEl = document.getElementById("current-child-info");
    const editIndicatorEl = document.getElementById("edit-indicator");
    const formErrorEl = document.getElementById("form-error");
    const formInfoEl = document.getElementById("form-info");

    const nameInput = document.getElementById("child-name");
    const nicknameInput = document.getElementById("child-nickname");
    const birthdayInput = document.getElementById("child-birthday");
    const saveBtn = document.getElementById("btn-save-child");
    const cancelEditBtn = document.getElementById("btn-cancel-edit");

    // Toast
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.remove("hidden");
      void toast.offsetWidth; // reflow
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => {
          toast.classList.add("hidden");
        }, 300);
      }, 2000);
    }

    function showError(msg) {
      formErrorEl.textContent = msg || "";
    }

    function showInfo(msg) {
      formInfoEl.textContent = msg || "";
    }

    // è®€å–ç›®å‰æ´»èºå­©å­çš„ ID
    function getActiveChildId() {
      const id = localStorage.getItem(ACTIVE_CHILD_KEY);
      return id ? parseInt(id, 10) : null;
    }

    // è¨­å®šç›®å‰æ´»èºå­©å­çš„ ID
    function setActiveChildId(childId) {
      if (childId === null) {
        localStorage.removeItem(ACTIVE_CHILD_KEY);
      } else {
        localStorage.setItem(ACTIVE_CHILD_KEY, childId);
      }
      renderCurrentChild();
      renderChildrenList(); // åˆ·æ–°åˆ—è¡¨ä»¥é¡¯ç¤º 'ç›®å‰å°æ€ªç¸' æ¨™ç±¤
    }

    function renderCurrentChild() {
      const activeId = getActiveChildId();
      const activeChild = children.find(c => c.id === activeId);

      if (!activeChild) {
        currentChildInfoEl.textContent =
          "ç›®å‰æ²’æœ‰é¸æ“‡çš„å­©å­ï¼Œè«‹å¾ä¸‹æ–¹æ¸…å–®é¸æ“‡ã€Œè¨­ç‚ºç›®å‰å°æ€ªç¸ã€ã€‚";
        return;
      }
      const displayName = activeChild.nickname || activeChild.name;
      currentChildInfoEl.textContent =
        "ç›®å‰æ“ä½œä¸­çš„å°æ€ªç¸æ˜¯ï¼šã€Œ" + displayName + "ã€ï¼Œä»»å‹™é»æ•¸èˆ‡ç´€éŒ„éƒ½æœƒè¨˜åœ¨é€™ä½å­©å­èº«ä¸Šã€‚";
    }

    function renderChildrenList() {
      childrenListEl.innerHTML = "";

      if (!children.length) {
        childrenListEl.innerHTML =
          '<p class="hint">ç›®å‰é‚„æ²’æœ‰å»ºç«‹ä»»ä½•å­©å­è³‡æ–™ï¼Œè«‹åœ¨å³å´æ–°å¢ä¸€ä½ã€‚</p>';
        return;
      }

      const activeId = getActiveChildId();

      children.forEach((child) => {
        const card = document.createElement("div");
        const isActive = activeId === child.id;

        card.className = `child-card ${isActive ? 'active-child' : ''}`; // â˜… æ–°å¢ active-child æ¨£å¼

        const mainName = child.name;
        const nick = child.nickname || "";
        const birthdayText = child.birthday
          ? "ç”Ÿæ—¥ï¼š" + child.birthday
          : "ç”Ÿæ—¥ï¼šæœªå¡«å¯«";

        card.innerHTML = `
          <div class="child-header">
            <div class="child-name">
              <span>ğŸ§’</span>
              <span>${mainName}</span>
              ${
                nick
                  ? `<span style="font-size:11px;color:#777;">ï¼ˆæš±ç¨±ï¼š${nick}ï¼‰</span>`
                  : ""
              }
              ${
                isActive
                  ? '<span class="child-badge">ç›®å‰å°æ€ªç¸</span>'
                  : ""
              }
            </div>
          </div>
          <div class="child-meta">${birthdayText}</div>
          <div class="child-actions">
            <button class="small" onclick="setAsActive(${child.id})">
              ${
                isActive ? "é‡æ–°è¨­ç‚ºç›®å‰å°æ€ªç¸" : "è¨­ç‚ºç›®å‰å°æ€ªç¸"
              }
            </button>
            <button class="small" onclick="startEditChild(${child.id})">ç·¨è¼¯</button>
            <button class="danger small" onclick="deleteChild(${child.id})">åˆªé™¤</button>
          </div>
        `;

        childrenListEl.appendChild(card);
      });
    }

    // æä¾›çµ¦ HTML onclick ä½¿ç”¨ï¼šè¨­ç‚ºç›®å‰å°æ€ªç¸
    window.setAsActive = function (childId) {
      const child = children.find((c) => c.id === childId);
      if (!child) return;
      setActiveChildId(childId); // åªéœ€è¦ ID
      showToast("å·²åˆ‡æ›ç›®å‰å°æ€ªç¸");
    };

    // ç·¨è¼¯å­©å­
    window.startEditChild = function (childId) {
      const child = children.find((c) => c.id === childId);
      if (!child) return;

      editingChildId = child.id;

      nameInput.value = child.name || "";
      nicknameInput.value = child.nickname || "";
      birthdayInput.value = child.birthday || "";

      editIndicatorEl.textContent = "ç›®å‰æ­£åœ¨ç·¨è¼¯ï¼šã€Œ" + (child.nickname || child.name) + "ã€";
      editIndicatorEl.style.display = "block";

      saveBtn.textContent = "å„²å­˜å­©å­è³‡æ–™";
      cancelEditBtn.style.display = "inline-block";

      showError("");
      showInfo("");

      document
        .getElementById("edit-section")
        .scrollIntoView({ behavior: "smooth" });
    };

    window.deleteChild = async function (childId) {
      const target = children.find((c) => c.id === childId);
      if (!target) return;

      // TODO: é€™è£¡è¦æ›æˆè‡ªè¨‚ UI æç¤ºï¼Œé¿å… alert/confirm
      const ok = confirm("ç¢ºå®šè¦åˆªé™¤ã€Œ" + (target.nickname || target.name) + "ã€å—ï¼Ÿ\nå·²ç”¢ç”Ÿçš„ä»»å‹™ç´€éŒ„èˆ‡é»æ•¸è³‡æ–™å»ºè­°ä¹‹å¾Œåœ¨å¾Œå°è™•ç†ã€‚");
      if (!ok) return;

      showError("");
      showInfo("åˆªé™¤ä¸­ï¼Œè«‹ç¨å€™â€¦");

      const { error } = await supabaseClient
        .from("children")
        .delete()
        .eq("id", childId)
        .eq("parent_id", currentUser.id);

      if (error) {
        console.error("åˆªé™¤å­©å­å¤±æ•—ï¼š", error);
        showError("åˆªé™¤å¤±æ•—ï¼š" + (error.message || "è«‹ç¨å¾Œå†è©¦"));
        showInfo("");
        return;
      }

      // å¦‚æœåˆªæ‰çš„æ˜¯ç›®å‰ active çš„é‚£ä½ï¼Œå°±æ¸…é™¤ active
      if (getActiveChildId() === childId) {
        setActiveChildId(null);
      }

      await loadChildren();
      showInfo("");
      showToast("å·²åˆªé™¤å­©å­");
    };

    function resetForm() {
      editingChildId = null;
      nameInput.value = "";
      nicknameInput.value = "";
      birthdayInput.value = "";
      saveBtn.textContent = "ï¼‹ æ–°å¢å­©å­";
      cancelEditBtn.style.display = "none";
      editIndicatorEl.style.display = "none";
      showError("");
      showInfo("");
    }

    async function handleSaveChild() {
      showError("");
      showInfo("");

      const name = nameInput.value.trim();
      const nickname = nicknameInput.value.trim();
      const birthday = birthdayInput.value; // YYYY-MM-DD æˆ– ""

      if (!name) {
        showError("è«‹å¡«å¯«å­©å­åå­—");
        return;
      }

      if (!currentUser) {
        showError("ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œè«‹é‡æ–°ç™»å…¥");
        return;
      }

      if (editingChildId === null) {
        // æ–°å¢
        showInfo("å»ºç«‹ä¸­ï¼Œè«‹ç¨å€™â€¦");
        const insertData = {
          parent_id: currentUser.id,
          name,
          nickname: nickname || null,
          birthday: birthday || null,
          total_points: 0, // â˜… æ–°å¢ï¼šåˆå§‹é»æ•¸ç‚º 0
          monsters_collected: [], // â˜… æ–°å¢ï¼šåˆå§‹æ€ªç¸åˆ—è¡¨ç‚ºç©º
        };

        const { data, error } = await supabaseClient
          .from("children")
          .insert(insertData)
          .select("*")
          .single();

        if (error) {
          console.error("æ–°å¢å­©å­å¤±æ•—ï¼š", error);
          showError("æ–°å¢å¤±æ•—ï¼š" + (error.message || "è«‹ç¨å¾Œå†è©¦"));
          showInfo("");
          return;
        }

        children.push(data);
        // å¦‚æœé€™æ˜¯ç¬¬ä¸€å€‹å­©å­ï¼Œè‡ªå‹•è¨­ç‚º active
        if (children.length === 1) {
            setActiveChildId(data.id);
        }
        
        renderChildrenList();
        resetForm();
        showToast("å·²æ–°å¢å­©å­");
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ redirect åƒæ•¸ï¼Œå¦‚æœæœ‰ï¼Œå°å›ç›®æ¨™é é¢
        const urlParams = new URLSearchParams(window.location.search);
        const redirectTarget = urlParams.get("redirect");
        if (redirectTarget) {
            window.location.href = redirectTarget;
        }

      } else {
        // ç·¨è¼¯
        showInfo("å„²å­˜ä¸­ï¼Œè«‹ç¨å€™â€¦");

        const updateData = {
          name,
          nickname: nickname || null,
          birthday: birthday || null,
          // total_points å’Œ monsters_collected ä¸åœ¨é€™è£¡ä¿®æ”¹
        };

        const { data, error } = await supabaseClient
          .from("children")
          .update(updateData)
          .eq("id", editingChildId)
          .eq("parent_id", currentUser.id)
          .select("*")
          .single();

        if (error) {
          console.error("æ›´æ–°å­©å­å¤±æ•—ï¼š", error);
          showError("å„²å­˜å¤±æ•—ï¼š" + (error.message || "è«‹ç¨å¾Œå†è©¦"));
          showInfo("");
          return;
        }

        const index = children.findIndex((c) => c.id === editingChildId);
        if (index !== -1) {
          children[index] = data;
        }

        // å¦‚æœé€™ä½å‰›å¥½æ˜¯ activeï¼Œæ›´æ–° local storage
        if (getActiveChildId() === editingChildId) {
          setActiveChildId(editingChildId);
        } else {
          renderChildrenList();
        }

        resetForm();
        showToast("å·²å„²å­˜å­©å­è³‡æ–™");
      }

      showInfo("");
    }

    // è®€å–å­©å­åˆ—è¡¨
    async function loadChildren() {
      if (!currentUser) return;
      const { data, error } = await supabaseClient
        .from("children")
        .select("id, name, nickname, birthday, total_points, monsters_collected") // è®€å–æ–°å¢çš„æ¬„ä½
        .eq("parent_id", currentUser.id)
        .order("created_at", { ascending: true });

      if (error) {
        console.error("è¼‰å…¥å­©å­åˆ—è¡¨å¤±æ•—ï¼š", error);
        childrenListEl.innerHTML =
          '<p class="hint">è¼‰å…¥å­©å­åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
        return;
      }

      children = data || [];
      renderChildrenList();
      renderCurrentChild();
    }

    // ç™»å…¥æª¢æŸ¥ (æ‰€æœ‰é é¢é€šç”¨)
    async function requireAuth() {
        const { data } = await supabaseClient.auth.getSession();
        if (!data.session || !data.session.user) {
            // ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œå°å‘ç™»å…¥é 
            const path = window.location.pathname;
            const fileName = path.substring(path.lastIndexOf("/") + 1) || "dashboard.html";
            const redirect = encodeURIComponent(fileName);
            window.location.href = `login.html?redirect=${redirect}`;
            return null;
        }
        return data.session.user;
    }

    // åˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", async () => {
      currentUser = await requireAuth();
      if (!currentUser) return;

      await loadChildren();
      
      // åœ¨ children.html è£¡ï¼Œå¦‚æœæ²’æœ‰ active childï¼Œå°‡ç¬¬ä¸€å€‹å­©å­è¨­ç‚º active (å¦‚æœæœ‰çš„è©±)
      if (getActiveChildId() === null && children.length > 0) {
          setActiveChildId(children[0].id);
      }

      saveBtn.addEventListener("click", handleSaveChild);
      cancelEditBtn.addEventListener("click", resetForm);
    });
  </script>
</body>
</html>
