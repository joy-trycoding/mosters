<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»Šæ—¥ä»»å‹™ï½œå°æ€ªç¸æŒ‘æˆ°ç‹</title>
  <style>
    :root {
      --bg-cream: #FFFDF6;
      --wood-main: #C68A56;
      --wood-dark: #5A3B24;
      --panel-bg: #FFFFFF;
      --accent-yellow: #FFE680;
      --panel-soft: #FFF4C8;
    }
    body {
      background: var(--bg-cream);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      margin: 0;
      padding: 12px;
    }
    .page {
      max-width: 640px;
      margin: 0 auto;
    }
    h1 {
      color: var(--wood-main);
      text-align: center;
      margin: 8px 0 10px;
      font-size: 22px;
    }
    /* å°è¦½åˆ—ï¼ˆå¤§æ‹‡æŒ‡å¥½æŒ‰ï¼‰ */
    .navbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .nav-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--wood-main);
      background: #FFF4C8;
      font-size: 14px;
      text-decoration: none;
      color: var(--wood-dark);
      min-width: 90px;
      text-align: center;
    }
    .nav-btn.active {
      background: var(--wood-main);
      color: white;
      font-weight: bold;
    }

    /* æç¤º / ä»Šæ—¥è³‡è¨Š */
    .info-bar {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }

    /* é»æ•¸å€å¡Šï¼šåšæˆå¤§å¡ç‰‡ï¼Œå®¹æ˜“ä¸€çœ¼çœ‹åˆ° */
    #points-box {
      margin: 0 0 12px;
      padding: 14px;
      background: var(--panel-soft);
      border-radius: 12px;
      border: 2px solid var(--wood-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 15px;
    }
    #points-box-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #points {
      font-weight: bold;
      font-size: 20px;
      color: var(--wood-dark);
    }
    .points-sub {
      font-size: 12px;
      color: #777;
    }

    /* ä»»å‹™å¡ç‰‡ï¼ˆæ‰‹æ©Ÿå–®æ¬„ï¼‰ */
    #tasks {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .task-card {
      background: var(--panel-bg);
      border: 1.5px solid var(--wood-main);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .task-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .task-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    .task-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--wood-dark);
    }
    .task-meta {
      font-size: 13px;
      color: #555;
    }
    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 14px;
      background: var(--accent-yellow);
      border: none;
      border-radius: 999px;
      font-size: 15px;
      cursor: pointer;
      flex: 1;
      min-width: 120px;
    }
    button.secondary {
      background: #FFF4C8;
      border: 1px solid var(--wood-main);
      font-size: 13px;
    }
    button:disabled {
      background: #DDD;
      color: #888;
      cursor: not-allowed;
    }

    .empty-hint {
      font-size: 14px;
      color: #777;
      text-align: center;
      margin-top: 24px;
      line-height: 1.6;
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 20px;
      }
      button {
        font-size: 14px;
      }
      .task-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<div class="page">

  <h1>ä»Šæ—¥ä»»å‹™</h1>

  <!-- å°è¦½åˆ— -->
  <div class="navbar">
    <a href="/dashboard.html" class="nav-btn active">ä»Šæ—¥ä»»å‹™</a>
    <a href="/rewards.html" class="nav-btn">çå‹µå°å±‹</a>
    <a href="/settings.html" class="nav-btn">ä»»å‹™è¨­å®š</a>
  </div>

  <div class="info-bar" id="today-info"></div>

  <div id="points-box">
    <div id="points-box-main">
      <span><strong>ä»Šæ—¥ç´¯ç©é»æ•¸</strong></span>
      <span id="points">0</span>
      <span class="points-sub">ï¼ˆç›®å‰ç‚ºç¤ºæ„ï¼Œä¹‹å¾Œæœƒæ”¹ç‚ºçœŸæ­£å¾Œç«¯è¨˜éŒ„ï¼‰</span>
    </div>
    <!-- æœªä¾†å¯æ”¾å°æœå‰æ’åœ– -->
  </div>

  <div id="tasks"></div>

  <div id="empty-message" class="empty-hint" style="display:none;">
    ä»Šå¤©æ²’æœ‰å®‰æ’ä»»å‹™ã€‚<br>
    å¯ä»¥åˆ°ã€Œä»»å‹™è¨­å®šã€é é¢ï¼Œå¹«å°æœ‹å‹æ–°å¢æˆ–èª¿æ•´æ¯æ—¥ä»»å‹™å–” ğŸ‹
  </div>

</div>

<script>
  // å’Œ settings.html å…±ç”¨çš„ key
  const STORAGE_KEY = "monsters_tasks_config_v1";
  const DEFAULT_ICON = "â­";

  // å’Œ settings.html ä¸€æ¨£çš„é è¨­ä»»å‹™ï¼ˆæ²’è¨­å®šæ™‚ç”¨ï¼‰
  const defaultTasks = [
    {
      id: 1,
      name: "èµ·åºŠä¸è³´åºŠ",
      points: 10,
      schedule: "everyday",
      icon: "â°",
      ttsText: "èµ·åºŠä¸è³´åºŠï¼Œå°å‹‡å£«å‡ºç™¼å›‰ï¼"
    },
    {
      id: 2,
      name: "è‡ªå·±åˆ·ç‰™",
      points: 10,
      schedule: "everyday",
      icon: "ğŸª¥",
      ttsText: "è‡ªå·±åˆ·ç‰™ï¼Œç‰™é½’äº®æ™¶æ™¶ã€‚"
    },
    {
      id: 3,
      name: "å®Œæˆå­¸æ ¡ä½œæ¥­",
      points: 20,
      schedule: "weekdays",
      icon: "ğŸ“š",
      ttsText: "å…ˆå®Œæˆå­¸æ ¡ä½œæ¥­ï¼Œå†é–‹å¿ƒç©è€ã€‚"
    },
    {
      id: 4,
      name: "æ•´ç†æ›¸åŒ…",
      points: 10,
      schedule: "weekdays",
      icon: "ğŸ’",
      ttsText: "æ•´ç†æ›¸åŒ…ï¼Œæ˜å¤©æ‰ä¸æœƒå¿˜æ±è¥¿ã€‚"
    },
    {
      id: 5,
      name: "æ”¶æ‹¾ç©å…·",
      points: 10,
      schedule: "everyday",
      icon: "ğŸ§¸",
      ttsText: "ç©å®Œç©å…·ï¼Œä¸€èµ·æŠŠå°å¤¥ä¼´å€‘é€å›å®¶ã€‚"
    }
  ];

  let fullConfig = [];   // æ‰€æœ‰ä»»å‹™è¨­å®šï¼ˆåŒ…å« oneTimeUsed ç‹€æ…‹ï¼‰
  let todayTasks = [];   // ä»Šå¤©è¦é¡¯ç¤ºçš„ä»»å‹™ï¼ˆæœƒåŠ  done å±¬æ€§ï¼‰
  let currentPoints = 0;

  function loadTaskConfig() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return defaultTasks.slice();
    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed) && parsed.length > 0) {
        return parsed;
      }
      return defaultTasks.slice();
    } catch (e) {
      console.error("è§£æä»»å‹™è¨­å®šå¤±æ•—ï¼Œæ”¹ç”¨é è¨­ä»»å‹™", e);
      return defaultTasks.slice();
    }
  }

  function saveTaskConfig() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(fullConfig));
  }

  // åˆ¤æ–·é€™å€‹ä»»å‹™ä»Šå¤©æ˜¯ä¸æ˜¯ã€Œé€±æœŸä¸Šã€éœ€è¦å‡ºç¾
  function isTaskForToday(task) {
    const schedule = task.schedule || "everyday";
    const today = new Date();
    const day = today.getDay(); 
    // 0: Sunday, 1: Monday, ... 6: Saturday

    if (schedule === "everyday") return true;
    if (schedule === "weekdays") {
      return day >= 1 && day <= 5;
    }
    if (schedule === "weekends") {
      return day === 0 || day === 6;
    }
    if (schedule === "one-time") {
      // one-time çš„é¡¯ç¤ºé‚è¼¯åœ¨ shouldShowTaskToday è£¡æœƒå†åˆ¤æ–· oneTimeUsed
      return true;
    }
    // æœªçŸ¥è¨­å®šï¼Œé è¨­é¡¯ç¤º
    return true;
  }

  // æœ€çµ‚æ±ºå®šä»Šå¤©è¦ä¸è¦é¡¯ç¤ºï¼šé€±æœŸ + one-time ä½¿ç”¨ç‹€æ…‹
  function shouldShowTaskToday(task) {
    // å¦‚æœæ˜¯ one-time ä¸”å·²ç¶“ç”¨éï¼Œå°±ä¸é¡¯ç¤º
    if (task.schedule === "one-time" && task.oneTimeUsed) {
      return false;
    }
    // å…¶é¤˜äº¤çµ¦ isTaskForToday
    return isTaskForToday(task);
  }

  function renderTodayInfo() {
    const el = document.getElementById("today-info");
    const today = new Date();
    const weekMap = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    const dateText = `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}ï¼ˆ${weekMap[today.getDay()]}ï¼‰`;
    el.textContent = `ä»Šå¤©æ˜¯ ${dateText}ï¼Œä»¥ä¸‹æ˜¯ä»Šå¤©çš„å°æ€ªç¸ä»»å‹™æ¸…å–®ã€‚`;
  }

  function renderTasks() {
    const container = document.getElementById("tasks");
    const emptyMessage = document.getElementById("empty-message");
    container.innerHTML = "";

    if (todayTasks.length === 0) {
      emptyMessage.style.display = "block";
      return;
    } else {
      emptyMessage.style.display = "none";
    }

    todayTasks.forEach(task => {
      const iconToShow = task.icon || DEFAULT_ICON;
      const btnLabel = task.done ? "å·²å®Œæˆ" : "å®Œæˆ";
      const disabledAttr = task.done ? "disabled" : "";

      const card = document.createElement("div");
      card.className = "task-card";

      card.innerHTML = `
        <div class="task-header">
          <div class="task-icon">${iconToShow}</div>
          <div>
            <div class="task-title">${task.name}</div>
            <div class="task-meta">é»æ•¸ï¼š${task.points} åˆ†</div>
          </div>
        </div>
        <div class="task-actions">
          <button ${disabledAttr} data-id="${task.id}" data-action="complete">
            ${btnLabel}
          </button>
          <button class="secondary" data-id="${task.id}" data-action="tts">
            ğŸ”Š æ’­æ”¾èªéŸ³
          </button>
        </div>
      `;

      container.appendChild(card);
    });

    // äº‹ä»¶ä»£ç†è™•ç†æŒ‰éˆ•ï¼ˆåœ¨ LINE in-app browser æ¯”è¼ƒç©©ï¼‰
    container.onclick = function (e) {
      const btn = e.target.closest("button");
      if (!btn) return;
      const taskId = parseInt(btn.getAttribute("data-id"), 10);
      const action = btn.getAttribute("data-action");
      if (action === "complete") {
        completeTask(taskId);
      } else if (action === "tts") {
        playTaskTTS(taskId);
      }
    };
  }

  function completeTask(id) {
    const t = todayTasks.find(x => x.id === id);
    if (!t || t.done) return;

    t.done = true;
    currentPoints += Number(t.points) || 0;
    updatePoints();
    renderTasks();

    // âœ… å¦‚æœæ˜¯ one-time ä»»å‹™ï¼Œæ¨™è¨˜ç‚ºå·²ä½¿ç”¨ï¼Œå¯«å› fullConfig
    if (t.schedule === "one-time") {
      const idx = fullConfig.findIndex(task => task.id === t.id);
      if (idx !== -1) {
        fullConfig[idx].oneTimeUsed = true;
        saveTaskConfig();
      }
    }

    alert(`ä»»å‹™ã€Œ${t.name}ã€å®Œæˆï¼å·²ç²å¾— ${t.points} åˆ† ğŸ‰`);
  }

  function updatePoints() {
    document.getElementById("points").textContent = currentPoints;
  }

  // ä½¿ç”¨ç€è¦½å™¨å…§å»ºèªéŸ³æœ—è®€ï¼ˆLINE webview ä¸Šæœ‰äº›æ©Ÿå‹å¯èƒ½ä¸æ”¯æ´ï¼‰
  function playTaskTTS(id) {
    const t = todayTasks.find(x => x.id === id);
    if (!t) return;

    const text = t.ttsText || t.name;

    if (!("speechSynthesis" in window)) {
      alert("é€™å€‹è£ç½®æš«æ™‚ä¸æ”¯æ´èªéŸ³æ’­æ”¾ï¼Œå¯ä»¥è«‹çˆ¸åª½å”¸çµ¦å°æœ‹å‹è½å–”ï¼");
      return;
    }

    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "zh-TW";
    utterance.rate = 1.0;
    utterance.pitch = 1.0;

    window.speechSynthesis.speak(utterance);
  }

  document.addEventListener("DOMContentLoaded", () => {
    renderTodayInfo();

    // è®€å–å®Œæ•´ä»»å‹™è¨­å®š
    fullConfig = loadTaskConfig();

    // æŒ‘å‡ºã€Œä»Šå¤©è¦é¡¯ç¤ºçš„ä»»å‹™ã€ï¼Œæ’é™¤ one-time å·²å®Œæˆè€…
    todayTasks = fullConfig
      .filter(shouldShowTaskToday)
      .map(t => ({
        ...t,
        done: false
      }));

    currentPoints = 0; // ç›®å‰å…ˆä¸åšè·¨æ—¥ç´€éŒ„
    updatePoints();
    renderTasks();
  });
</script>

</body>
</html>



