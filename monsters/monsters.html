<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å°æ€ªç¸æ£®æ—ï½œæ”¶é›†è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* æ–°å¢ï¼šæ€ªç¸å¡ç‰‡è¦–è¦ºå„ªåŒ– */
    .monster-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .monster-card {
      text-align: center;
      padding: 10px;
      border-radius: 12px;
      border: 2px solid #C68A56;
      background: #FFFDF6;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .monster-card.collected {
        border-color: #4CAF50;
    }
    .monster-card.locked {
        opacity: 0.6;
        filter: grayscale(100%);
        background: #F0F0F0;
        border-style: dashed;
        cursor: help;
    }

    .monster-card.big {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin-bottom: 20px;
    }

    .monster-avatar {
      font-size: 40px;
      margin-bottom: 8px;
    }

    .monster-visual {
      width: 100px;
      height: 100px;
      margin: 10px auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .egg-animation {
      font-size: 60px;
      animation: wobble 1s ease-in-out infinite alternate;
    }

    @keyframes wobble {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(2deg) scale(1.05); }
      100% { transform: rotate(-2deg) scale(1); }
    }

    .monster-details h3 {
      margin-top: 0;
    }

    .monster-card h3 {
        font-size: 16px;
        color: #5A3B24;
    }
    .tag {
        font-size: 11px;
        color: #888;
        margin-bottom: 4px;
    }
    .meta {
        font-size: 12px;
        color: #666;
    }
    .hint-new {
        color: #E74C3C;
        font-weight: bold;
        margin-top: 10px;
    }

  </style>
</head>
<body>
  <!-- å…±ç”¨ header -->
  <div class="navbar">
    <a href="index.html" class="nav-btn">é¦–é </a>
    <a href="dashboard.html" class="nav-btn">ä»Šæ—¥ä»»å‹™</a>
    <a href="setting.html" class="nav-btn">ä»»å‹™è¨­å®š</a>
    <a href="rewards.html" class="nav-btn">çå‹µå•†åŸ</a>
    <a href="monsters.html" class="nav-btn active">å°æ€ªç¸æ£®æ—</a>
    <a href="story.html" class="nav-btn">æŒ‘æˆ°ç‹æ•…äº‹</a>    
    <a href="children.html" class="nav-btn">å­©å­è³‡æ–™</a> 
</div>
  <main class="page page-monsters">
    <h1>å°æ€ªç¸æ£®æ—ï½œæ”¶é›†è¡¨</h1>
    <p>ã€æœ¬æ©Ÿæ¸¬è©¦æ¨¡å¼ã€‘æ‰€æœ‰è³‡æ–™éƒ½å„²å­˜åœ¨é€™å€‹ç€è¦½å™¨ï¼Œæ›è£ç½®æœƒæ¶ˆå¤±ã€‚</p>

    <!-- å­µåŒ–ä¸­çš„æ€ªç¸å€ -->
    <section class="current-hatch">
      <h2>ç›®å‰é»æ•¸èˆ‡å­µåŒ–é€²åº¦</h2>
      <div class="monster-card big" id="hatch-status-card">
        <!-- é€™è£¡å°‡ç”± JS æ¸²æŸ“å…§å®¹ -->
        è¼‰å…¥ä¸­...
      </div>
    </section>

    <!-- å…¨éƒ¨æ€ªç¸æ”¶é›†è¡¨ -->
    <section class="collection">
      <h2>æ€ªç¸æ”¶é›†è¡¨ (å·²æ”¶é›† <span id="collected-count">0</span> / <span id="total-count">20</span>)</h2>
      <div class="monster-grid" id="monster-collection-grid">
        <!-- æ€ªç¸åˆ—è¡¨å°‡ç”± JS æ¸²æŸ“ -->
      </div>
    </section>
  </main>
  <script>
  // ç§»é™¤ Supabase è…³æœ¬

  const CHILDREN_STORAGE_KEY = "monsters_children_local"; 
  const ACTIVE_CHILD_KEY = "monsters_active_child_id";
  const TOTAL_MONSTERS = 20; // ç¸½æ€ªç¸æ•¸
  const HATCH_THRESHOLD = 100; // å­µåŒ–é»æ•¸é–€æª»
  
  let childrenData = [];
  let activeChildData = null; 

  // â˜… è™›æ“¬æ€ªç¸è³‡æ–™åº« (ç­‰å¾…æ‚¨è¨­è¨ˆè§’è‰²å¾Œæ›¿æ›)
  const MONSTER_DB = [
    { id: 'm01', name: 'å°æœå‰', icon: 'ğŸ‹', description: 'å‹‡æ•¢ç·´ç¿’å‹', condition: 'åˆå§‹å¤¥ä¼´' },
    { id: 'm02', name: 'å°è‰æ€ª', icon: 'ğŸŒ±', description: 'å®‰éœå®ˆè­·è€…', condition: 'ç´¯ç©100é»' },
    { id: 'm03', name: 'ç«ç«é¾', icon: 'ğŸ”¥', description: 'ç†±æƒ…å¥”è·‘è€…', condition: 'ç´¯ç©200é»' },
    { id: 'm04', name: 'å†°æ·‡æ·‹', icon: 'ğŸ¦', description: 'ç”œç¾æ€è€ƒå®¶', condition: 'ç´¯ç©300é»' },
    { id: 'm05', name: 'å°é›²æœµ', icon: 'â˜ï¸', description: 'å¤¢æƒ³è§€å¯Ÿå®¶', condition: 'ç´¯ç©400é»' },
    // ... (ä¿æŒ 20 éš»æ€ªç¸çš„è³‡æ–™)
    { id: 'm06', name: 'å½©è™¹é¦¬', icon: 'ğŸŒˆ', description: 'å¿«æ¨‚è£½é€ æ©Ÿ', condition: 'ç´¯ç©500é»' },
    { id: 'm07', name: 'æ˜Ÿæ˜Ÿé­š', icon: 'â­ï¸', description: 'çŸ¥è­˜æ¢éšªå®¶', condition: 'ç´¯ç©600é»' },
    { id: 'm08', name: 'å°èœœèœ‚', icon: 'ğŸ', description: 'å‹¤å‹å°åŠ©æ‰‹', condition: 'ç´¯ç©700é»' },
    { id: 'm09', name: 'ç©æœ¨ç¸', icon: 'ğŸ§±', description: 'å‰µæ„å»ºç¯‰å¸«', condition: 'ç´¯ç©800é»' },
    { id: 'm10', name: 'æ³¡æ³¡çƒ', icon: 'ğŸ«§', description: 'å¥½å¥‡ç™¼å•è€…', condition: 'ç´¯ç©900é»' },
    { id: 'm11', name: 'æ©Ÿå™¨äºº', icon: 'ğŸ¤–', description: 'é‚è¼¯åˆ†æå¸«', condition: 'ç´¯ç©1000é»' },
    { id: 'm12', name: 'æ©¡çš®æ“¦', icon: 'âœï¸', description: 'éŒ¯èª¤ä¿®æ­£å“¡', condition: 'ç´¯ç©1100é»' },
    { id: 'm13', name: 'å°ç«è»Š', icon: 'ğŸš‚', description: 'æ™‚é–“ç®¡ç†è€…', condition: 'ç´¯ç©1200é»' },
    { id: 'm14', name: 'é£›ç¢Ÿå¸½', icon: 'ğŸ‘½', description: 'æƒ³åƒåŠ›å¤§ç‹', condition: 'ç´¯ç©1300é»' },
    { id: 'm15', name: 'ç‡ˆæ³¡ç²¾', icon: 'ğŸ’¡', description: 'éˆæ„Ÿæ•æ‰è€…', condition: 'ç´¯ç©1400é»' },
    { id: 'm16', name: 'æœˆäº®è‡‰', icon: 'ğŸŒ', description: 'æƒ…ç·’èª¿é©å®¶', condition: 'ç´¯ç©1500é»' },
    { id: 'm17', name: 'å°æ›¸èŸ²', icon: 'ğŸ›', description: 'é–±è®€æ„›å¥½è€…', condition: 'ç´¯ç©1600é»' },
    { id: 'm18', name: 'ç›¸æ©Ÿç¸', icon: 'ğŸ“¸', description: 'ç¾å¥½ç´€éŒ„è€…', condition: 'ç´¯ç©1700é»' },
    { id: 'm19', name: 'ç¡è¢‹ç†Š', icon: 'ğŸ»', description: 'è¦å¾‹ä¼‘æ¯è€…', condition: 'ç´¯ç©1800é»' },
    { id: 'm20', name: 'å¤¢æƒ³å®¶', icon: 'âœ¨', description: 'çµ‚æ¥µæŒ‘æˆ°ç‹', condition: 'ç´¯ç©1900é»' },
  ].slice(0, TOTAL_MONSTERS);

  // --- LocalStorage æ•¸æ“šè¼‰å…¥/ä¿å­˜ ---
  function loadLocalData() {
    const savedChildren = localStorage.getItem(CHILDREN_STORAGE_KEY);
    try {
        childrenData = savedChildren ? JSON.parse(savedChildren) : [];
    } catch { childrenData = []; }
    
    const activeId = parseInt(localStorage.getItem(ACTIVE_CHILD_KEY), 10);
    activeChildData = childrenData.find(c => c.id === activeId) || null;
    
    if (!activeChildData && childrenData.length > 0) {
        window.location.href = 'children.html';
        return false;
    }
    if (childrenData.length === 0) {
        window.location.href = 'children.html';
        return false;
    }
    return true; 
  }
  
  function saveChildrenData() {
      localStorage.setItem(CHILDREN_STORAGE_KEY, JSON.stringify(childrenData));
  }
  // ---------------------------------

  // â˜… æ¸²æŸ“æ€ªç¸å­µåŒ–é€²åº¦èˆ‡åˆ—è¡¨
  function renderMonsters() {
      if (!activeChildData) {
          document.getElementById('hatch-status-card').innerHTML = "è«‹å…ˆåˆ°ã€Œå­©å­è³‡æ–™ã€é é¢è¨­å®šä¸€ä½å°æ€ªç¸å®ˆè­·è€…ã€‚";
          return;
      }

      const totalPoints = activeChildData.total_points;
      let collectedIds = activeChildData.monsters_collected || ['m01'];
      
      const currentMonsterCount = collectedIds.length;
      const potentialMonsterCount = Math.floor(totalPoints / HATCH_THRESHOLD);
      
      document.getElementById('collected-count').textContent = currentMonsterCount;
      document.getElementById('total-count').textContent = TOTAL_MONSTERS;
      
      const isHatchingReady = potentialMonsterCount > currentMonsterCount;
      
      // 1. æ¸²æŸ“å­µåŒ–ç‹€æ…‹å¡
      const hatchCardEl = document.getElementById('hatch-status-card');
      if (isHatchingReady) {
          // æœ‰æ–°æ€ªç¸å¯å­µåŒ–ï¼
          hatchCardEl.innerHTML = `
            <div class="monster-visual">
                <div class="egg-animation" style="animation: wobble 0.5s ease-in-out infinite alternate;">ğŸ¥š</div>
            </div>
            <div class="monster-details">
                <h3>æœ‰æ–°çš„å°æ€ªç¸æº–å‚™ç ´æ®¼äº†ï¼</h3>
                <p class="hint-new">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹å­µåŒ–ï¼</p>
                <p>ç›®å‰é»æ•¸ï¼š${totalPoints} åˆ†</p>
                <button onclick="hatchNextMonster()">é»æˆ‘å­µåŒ–</button>
            </div>
          `;
      } else {
          // ä»åœ¨ç´¯ç©é»æ•¸
          const neededPoints = HATCH_THRESHOLD - (totalPoints % HATCH_THRESHOLD);
          hatchCardEl.innerHTML = `
            <div class="monster-visual">
                <div class="egg-animation">ğŸ¥š</div>
            </div>
            <div class="monster-details">
                <h3>å°æ€ªç¸è›‹æ­£åœ¨æº«æš–ä¸­...</h3>
                <p>å†ç´¯ç© **${neededPoints}** é»ï¼Œå°±èƒ½å­µåŒ–ä¸‹ä¸€éš»æ€ªç¸ï¼</p>
                <p>ç›®å‰é»æ•¸ï¼š${totalPoints} åˆ† (é€²åº¦: ${HATCH_THRESHOLD - neededPoints} / ${HATCH_THRESHOLD})</p>
            </div>
          `;
      }
      
      // 2. æ¸²æŸ“æ”¶é›†åˆ—è¡¨
      const gridEl = document.getElementById('monster-collection-grid');
      gridEl.innerHTML = MONSTER_DB.map((monster, index) => {
          const isCollected = collectedIds.includes(monster.id);
          const isNextInLine = index === currentMonsterCount;
          
          return `
            <div class="monster-card ${isCollected ? 'collected' : 'locked'}">
              <div class="monster-avatar">${isCollected ? monster.icon : (isNextInLine ? 'ğŸ£' : 'â“')}</div>
              <h3>${isCollected ? monster.name : 'ï¼Ÿï¼Ÿï¼Ÿ'}</h3>
              <p class="tag">${isCollected ? monster.description : (isNextInLine ? 'ä¸‹ä¸€éš»' : 'æœªè§£é–')}</p>
              <p class="meta">${isCollected ? `ç¬¬ ${index + 1} éš»` : monster.condition}</p>
            </div>
          `;
      }).join('');
  }

  // â˜… å­µåŒ–ä¸‹ä¸€éš»æ€ªç¸çš„é‚è¼¯ (æ›´æ–° LocalStorage)
  window.hatchNextMonster = function () {
      if (!activeChildData) return;
      
      let collectedIds = activeChildData.monsters_collected || ['m01'];
      
      const currentMonsterCount = collectedIds.length;
      const potentialMonsterCount = Math.floor(activeChildData.total_points / HATCH_THRESHOLD);

      if (potentialMonsterCount <= currentMonsterCount) {
          alert("é»æ•¸é‚„ä¸å¤ å­µåŒ–ä¸‹ä¸€éš»å–”ï¼è«‹å…ˆå®Œæˆä»»å‹™ã€‚");
          return;
      }
      
      const nextMonster = MONSTER_DB[currentMonsterCount];
      if (!nextMonster) {
          alert("æ­å–œæ‚¨ï¼æ‰€æœ‰æ€ªç¸éƒ½å·²ç¶“æ”¶é›†å®Œæˆäº†ï¼");
          return;
      }
      
      collectedIds.push(nextMonster.id);
      
      // æ›´æ–° LocalStorage 
      activeChildData.monsters_collected = collectedIds;
      const childIndex = childrenData.findIndex(c => c.id === activeChildData.id);
      if (childIndex !== -1) {
          childrenData[childIndex].monsters_collected = collectedIds;
          saveChildrenData(); 
      }
      
      alert(`ğŸ‰ æ­å–œï¼ä½ å­µåŒ–äº†æ–°çš„å°æ€ªç¸ï¼šã€${nextMonster.name}ã€‘ï¼`);
      renderMonsters();
  }


  // é é¢åˆå§‹åŒ–æ™‚å…ˆæª¢æŸ¥
  document.addEventListener("DOMContentLoaded", async () => {
    const isReady = loadLocalData();
    if (!isReady) return;
    
    renderMonsters();
  });
</script>

</body>
</html>


