<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ä»»å‹™è¨­å®šï½œå°æ€ªç¸æŒ‘æˆ°ç‹</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      background: #FFFDF6;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      color: #C68A56;
      text-align: center;
      margin-bottom: 12px;
    }
    /* å°è¦½åˆ—æ¨£å¼ */
    .navbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .nav-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #C68A56;
      background: #FFF4C8;
      font-size: 14px;
      text-decoration: none;
      color: #5A3B24;
    }
    .nav-btn.active {
      background: #C68A56;
      color: white;
      font-weight: bold;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
      .col {
        flex: 1;
      }
    }

    .panel {
      background: #FFFFFF;
      border-radius: 12px;
      border: 2px solid #C68A56;
      padding: 16px;
      margin-bottom: 12px;
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #5A3B24;
    }
    .panel p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #666;
    }

    .task-card {
      border: 1px solid #E0C7A0;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      background: #FFFAED;
      font-size: 14px;
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .task-name {
      font-weight: bold;
    }
    .task-icon {
      font-size: 18px;
      margin-right: 4px;
    }
    .task-meta {
      font-size: 12px;
      color: #555;
    }
    .task-actions {
      margin-top: 4px;
      text-align: right;
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }
    button {
      padding: 6px 12px;
      background: #FFE680;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #FFD966;
    }
    button.danger {
      background: #F4B0A8;
    }
    button.small {
      font-size: 12px;
      padding: 4px 10px;
    }

    /* è¡¨å–®æ¨£å¼ */
    .form-row {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
      color: #5A3B24;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #C68A56;
      font-size: 14px;
      background: #FFFCF4;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .hint {
      font-size: 12px;
      color: #888;
    }
    .json-box {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #C68A56;
      background: #FFFCF4;
      font-size: 11px;
      font-family: Consolas, monospace;
      white-space: pre-wrap;
    }
    .edit-indicator {
      font-size: 12px;
      color: #B35B3E;
      margin-bottom: 8px;
    }

    /* æç¤ºè¨Šæ¯ Toast */
    .toast {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 22px;
      border-radius: 12px;
      font-size: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<h1>ä»»å‹™è¨­å®š</h1>

<!-- å°è¦½åˆ—ï¼šçµ±ä¸€å°è¦½åˆ— -->
<div class="navbar">
  <a href="index.html" class="nav-btn">é¦–é </a>
  <a href="dashboard.html" class="nav-btn ">ä»Šæ—¥ä»»å‹™</a>
  <a href="setting.html" class="nav-btn active">ä»»å‹™è¨­å®š</a>
  <a href="rewards.html" class="nav-btn">çå‹µå•†åŸ</a>
  <a href="monsters.html" class="nav-btn">å°æ€ªç¸æ£®æ—</a>
  <a href="story.html" class="nav-btn">æŒ‘æˆ°ç‹æ•…äº‹</a>
  <a href="children.html" class="nav-btn">å­©å­è³‡æ–™</a> 
</div>

<div class="layout">
  <!-- å·¦é‚Šï¼šç›®å‰ä»»å‹™åˆ—è¡¨ -->
  <div class="col">
    <div class="panel" id="task-list-section">
      <h2>ç›®å‰ä»»å‹™åˆ—è¡¨</h2>
      <p>é€™è£¡æœƒé¡¯ç¤ºç¾åœ¨æ‰€æœ‰ä»»å‹™ã€‚ç›®å‰ä»»å‹™å„²å­˜åœ¨æ­¤ç€è¦½å™¨ï¼Œå°šæœªä¸²æ¥å¾Œç«¯ã€‚</p>
      <div id="task-list"></div>
    </div>
  </div>

  <!-- å³é‚Šï¼šæ–°å¢ / ç·¨è¼¯ä»»å‹™è¡¨å–® -->
  <div class="col">
    <div class="panel" id="edit-section">
      <h2>æ–°å¢ / ç·¨è¼¯ä»»å‹™</h2>
      <p>æ–°å¢ä»»å‹™å¾Œæœƒå„²å­˜åœ¨é€™å°è£ç½®çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚</p>

      <div id="edit-indicator" class="edit-indicator" style="display:none;"></div>

      <div class="form-row">
        <label for="task-name">ä»»å‹™åç¨±ï¼ˆçµ¦çˆ¸åª½çœ‹ï¼‰</label>
        <input id="task-name" type="text" placeholder="ä¾‹å¦‚ï¼šæ•´ç†æ›¸åŒ…ã€æ”¶æ‹¾ç©å…·">
      </div>

      <div class="form-row">
        <label for="task-points">ä»»å‹™é»æ•¸</label>
        <input id="task-points" type="number" min="1" max="100" value="10">
      </div>

      <div class="form-row">
        <label for="task-schedule">ä»»å‹™é€±æœŸ</label>
        <select id="task-schedule">
          <option value="everyday">æ¯å¤©</option>
          <option value="weekdays">é€±ä¸€ï½é€±äº”</option>
          <option value="weekends">é€±å…­ã€é€±æ—¥</option>
          <option value="one-time">è‡¨æ™‚ä»»å‹™ (åªå‡ºç¾ä¸€æ¬¡)</option>
        </select>
        <div class="hint">ç›®å‰åªæ”¯æ´ç°¡å–®çš„é€±æœŸè¨­å®šã€‚</div>
      </div>

      <div class="form-row">
        <label for="task-icon">åœ–æ¡ˆï¼ˆemojiï¼Œå¯é¸ï¼‰</label>
        <input id="task-icon" type="text" placeholder="ä¾‹å¦‚ï¼šğŸ§¸ / ğŸ“š / â­ ï¼›å¦‚æœç•™ç™½æœƒç”¨é è¨­åœ–æ¡ˆ">
        <div class="hint">ä¸å¡«çš„è©±ï¼Œæœƒè‡ªå‹•ä½¿ç”¨é è¨­ emojiï¼ˆâ­ï¼‰ã€‚</div>
      </div>

      <div class="form-row">
        <label for="task-tts">èªéŸ³æœ—è®€å…§å®¹ï¼ˆå¯é¸ï¼Œçµ¦å°å­©è½ï¼‰</label>
        <textarea id="task-tts" placeholder="ä¾‹å¦‚ï¼šæ•´ç†æ›¸åŒ…ï¼Œæ˜å¤©ä¸Šå­¸æ‰ä¸æœƒå¿˜è¨˜æ±è¥¿ã€‚"></textarea>
        <div class="hint">ä¸å¡«çš„è©±ï¼Œæœƒç”¨ä»»å‹™åç¨±ç›´æ¥å”¸ã€‚é€™æ˜¯çµ¦ä»»å‹™é  TTS ç”¨çš„å…§å®¹ã€‚</div>
      </div>

      <div class="form-row" style="display:flex; gap:8px;">
        <button id="add-task-btn">ï¼‹ æ–°å¢ä»»å‹™</button>
        <button id="cancel-edit-btn" type="button" class="small" style="display:none;">
          å–æ¶ˆç·¨è¼¯
        </button>
      </div>
    </div>
  </div>
</div>

<!-- æç¤ºè¨Šæ¯å®¹å™¨ -->
<div id="toast" class="toast hidden">ä»»å‹™è¨­å®šå®Œæˆ</div>

<script>
  // å„²å­˜åœ¨ localStorage çš„ key
  const STORAGE_KEY = "monsters_tasks_config_v1";
  const DEFAULT_ICON = "â­";

  // é è¨­ä»»å‹™ï¼ˆç¬¬ä¸€æ¬¡æ²’æœ‰è³‡æ–™æ™‚ä½¿ç”¨ï¼‰
  const defaultTasks = [
    { id: 1, name: "èµ·åºŠä¸è³´åºŠ", points: 10, schedule: "everyday", icon: "â°", ttsText: "èµ·åºŠä¸è³´åºŠï¼Œå°å‹‡å£«å‡ºç™¼å›‰ï¼" },
    { id: 2, name: "è‡ªå·±åˆ·ç‰™", points: 10, schedule: "everyday", icon: "ğŸª¥", ttsText: "è‡ªå·±åˆ·ç‰™ï¼Œç‰™é½’äº®æ™¶æ™¶ã€‚" },
    { id: 3, name: "å®Œæˆå­¸æ ¡ä½œæ¥­", points: 20, schedule: "weekdays", icon: "ğŸ“š", ttsText: "å…ˆå®Œæˆå­¸æ ¡ä½œæ¥­ï¼Œå†é–‹å¿ƒç©è€ã€‚" },
    { id: 4, name: "æ•´ç†æ›¸åŒ…", points: 10, schedule: "weekdays", icon: "ğŸ’", ttsText: "æ•´ç†æ›¸åŒ…ï¼Œæ˜å¤©æ‰ä¸æœƒå¿˜æ±è¥¿ã€‚" },
    { id: 5, name: "æ”¶æ‹¾ç©å…·", points: 10, schedule: "everyday", icon: "ğŸ§¸", ttsText: "ç©å®Œç©å…·ï¼Œä¸€èµ·æŠŠå°å¤¥ä¼´å€‘é€å›å®¶ã€‚" }
  ];

  let tasks = [];
  let editingTaskId = null; // null ä»£è¡¨ã€Œæ–°å¢æ¨¡å¼ã€

  function loadTasks() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        tasks = JSON.parse(saved);
      } catch (e) {
        console.error("è§£æä»»å‹™è¨­å®šå¤±æ•—ï¼Œæ”¹ç”¨é è¨­ä»»å‹™", e);
        tasks = defaultTasks.slice();
      }
    } else {
      tasks = defaultTasks.slice();
    }
  }

  function saveTasks() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    renderTaskList();
  }

  function renderTaskList() {
    const container = document.getElementById("task-list");
    container.innerHTML = "";

    if (tasks.length === 0) {
      container.innerHTML = '<p class="hint">ç›®å‰æ²’æœ‰ä»»å‹™ï¼Œè«‹å¾å³é‚Šæ–°å¢ã€‚</p>';
      return;
    }

    tasks.forEach(task => {
      const scheduleText =
        task.schedule === "everyday"
          ? "æ¯å¤©"
          : task.schedule === "weekdays"
          ? "é€±ä¸€ï½é€±äº”"
          : task.schedule === "weekends"
          ? "é€±å…­ã€é€±æ—¥"
          : task.schedule === "one-time"
          ? "è‡¨æ™‚ä»»å‹™ (ä¸€æ¬¡æ€§)"
          : "æœªè¨­å®š";

      const iconToShow = task.icon || DEFAULT_ICON;

      const div = document.createElement("div");
      div.className = "task-card";
      div.innerHTML = `
        <div class="task-header">
          <div>
            <span class="task-icon">${iconToShow}</span>
            <span class="task-name">${task.name}</span>
          </div>
          <div>${task.points} åˆ†</div>
        </div>
        <div class="task-meta">
          é€±æœŸï¼š${scheduleText}
        </div>
        <div class="task-meta">
          èªéŸ³å…§å®¹ï¼š${task.ttsText ? task.ttsText : "ï¼ˆæœªè¨­å®šï¼Œæœƒå”¸ä»»å‹™åç¨±ï¼‰"}
        </div>
        <div class="task-actions">
          <button class="small" onclick="startEditTask(${task.id})">ç·¨è¼¯</button>
          <button class="danger small" onclick="deleteTask(${task.id})">åˆªé™¤</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function resetFormToCreateMode() {
    editingTaskId = null;
    document.getElementById("task-name").value = "";
    document.getElementById("task-points").value = "10";
    document.getElementById("task-schedule").value = "everyday";
    document.getElementById("task-icon").value = "";
    document.getElementById("task-tts").value = "";

    document.getElementById("add-task-btn").textContent = "ï¼‹ æ–°å¢ä»»å‹™";
    document.getElementById("edit-indicator").style.display = "none";
    document.getElementById("cancel-edit-btn").style.display = "none";
  }

  function startEditTask(id) {
    const t = tasks.find(task => task.id === id);
    if (!t) return;

    editingTaskId = id;

    // æŠŠä»»å‹™å…§å®¹å¸¶å…¥è¡¨å–®
    document.getElementById("task-name").value = t.name;
    document.getElementById("task-points").value = t.points;
    document.getElementById("task-schedule").value = t.schedule || "everyday";
    document.getElementById("task-icon").value = t.icon || "";
    document.getElementById("task-tts").value = t.ttsText || "";

    // æ›´æ–° UI æç¤º
    const indicator = document.getElementById("edit-indicator");
    indicator.textContent = `ç›®å‰æ­£åœ¨ç·¨è¼¯ï¼š${t.name}`;
    indicator.style.display = "block";

    const addBtn = document.getElementById("add-task-btn");
    addBtn.textContent = "å„²å­˜ä¿®æ”¹";

    const cancelBtn = document.getElementById("cancel-edit-btn");
    cancelBtn.style.display = "inline-block";

    document
      .getElementById("edit-section")
      .scrollIntoView({ behavior: "smooth" });
  }

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;

    toast.classList.remove("hidden");
    void toast.offsetWidth;
    toast.classList.add("show");

    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => {
        toast.classList.add("hidden");
      }, 300);
    }, 2000); 
  }

  function handleFormSubmit() {
    const nameInput = document.getElementById("task-name");
    const pointsInput = document.getElementById("task-points");
    const scheduleSelect = document.getElementById("task-schedule");
    const iconInput = document.getElementById("task-icon");
    const ttsInput = document.getElementById("task-tts");

    const name = nameInput.value.trim();
    const points = parseInt(pointsInput.value, 10);
    const schedule = scheduleSelect.value;
    const icon = iconInput.value.trim();
    const ttsText = ttsInput.value.trim();

    if (!name) {
      showToast("è«‹è¼¸å…¥ä»»å‹™åç¨±");
      return;
    }
    if (isNaN(points) || points <= 0) {
      showToast("è«‹è¼¸å…¥å¤§æ–¼ 0 çš„é»æ•¸");
      return;
    }

    if (editingTaskId === null) {
      // æ–°å¢æ¨¡å¼
      const newId =
        tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;

      const newTask = {
        id: newId,
        name,
        points,
        schedule,
        icon: icon || undefined,
        ttsText: ttsText || undefined
      };

      tasks.push(newTask);
      saveTasks();
      resetFormToCreateMode();

      document
        .getElementById("task-list-section")
        .scrollIntoView({ behavior: "smooth" });
      showToast(`å·²æ–°å¢ä»»å‹™ï¼šã€Œ${name}ã€`);
    } else {
      // ç·¨è¼¯æ¨¡å¼
      const t = tasks.find(task => task.id === editingTaskId);
      if (!t) {
        showToast("æ‰¾ä¸åˆ°é€™å€‹ä»»å‹™ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
        return;
      }

      t.name = name;
      t.points = points;
      t.schedule = schedule;
      t.icon = icon || undefined;
      t.ttsText = ttsText || undefined;

      saveTasks();
      resetFormToCreateMode();

      document
        .getElementById("task-list-section")
        .scrollIntoView({ behavior: "smooth" });
      showToast("ä»»å‹™è¨­å®šå®Œæˆ");
    }
  }

  function deleteTask(id) {
    const target = tasks.find(t => t.id === id);
    if (!target) return;
    
    // âš ï¸ é€™è£¡å…ˆä¿ç•™åŸæœ‰çš„ confirm() é‚è¼¯ï¼Œä½†å»ºè­°æœªä¾†æ›¿æ›ç‚ºè‡ªè¨‚ UI æ¨¡çµ„
    const ok = window.confirm(`ç¢ºå®šè¦åˆªé™¤ä»»å‹™ã€Œ${target.name}ã€å—ï¼Ÿ`);
    if (!ok) return;

    tasks = tasks.filter(t => t.id !== id);
    saveTasks();

    if (editingTaskId === id) {
      resetFormToCreateMode();
    }
    showToast(`å·²åˆªé™¤ä»»å‹™ï¼šã€Œ${target.name}ã€`);
  }

  // ç¶å®šæŒ‰éˆ•äº‹ä»¶
  document.addEventListener("DOMContentLoaded", () => {
    loadTasks();
    renderTaskList();

    document
      .getElementById("add-task-btn")
      .addEventListener("click", handleFormSubmit);

    document
      .getElementById("cancel-edit-btn")
      .addEventListener("click", resetFormToCreateMode);
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // çµ±ä¸€çš„ Supabase è¨­å®š (ä½¿ç”¨æ‚¨ login.html ä¸­çš„çœŸå¯¦é‡‘é‘°)
  const SUPABASE_URL = "https://reunrobejvodzkhbtspp.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJldW5yb2JlanZvZHpraGJ0c3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMzc1MDEsImV4cCI6MjA3OTgxMzUwMX0.4Tfa94upcxp2wfnBUwBtFJl7H1NdnY3uQxLRxnjBrRE";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // è¤‡è£½è‡ª dashboard.html çš„ checkActiveChildAndRedirect é‚è¼¯
  async function checkActiveChildAndRedirect(user) {
      // 1. æª¢æŸ¥æ˜¯å¦æœ‰å­©å­è³‡æ–™
      let hasChild = false;
      const { data: childrenRows, error: childrenError } = await supabaseClient
        .from("children")
        .select("id")
        .eq("parent_id", user.id)
        .limit(1);

      if (!childrenError && childrenRows && childrenRows.length > 0) {
        hasChild = true;
      }
      
      // 2. å¦‚æœæ²’æœ‰å­©å­ï¼Œå¼·åˆ¶è·³è½‰åˆ° children.html
      if (!hasChild) {
        // å–å¾—ç›®å‰é é¢çš„æª”åï¼Œä¾‹å¦‚ setting.html
        const path = window.location.pathname;
        const fileName = path.substring(path.lastIndexOf("/") + 1) || "setting.html";
        const redirect = encodeURIComponent(fileName);
        window.location.href = `children.html?redirect=${redirect}`;
        return false; // é˜»æ­¢å¾ŒçºŒè¼‰å…¥
      }
      return true; // æœ‰å­©å­ï¼Œç¹¼çºŒè¼‰å…¥é é¢
  }

  async function requireAuth() {
    const { data } = await supabaseClient.auth.getSession();
    
    if (!data.session || !data.session.user) {
      // ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œå°å‘ç™»å…¥é 
      const path = window.location.pathname;
      const fileName = path.substring(path.lastIndexOf("/") + 1) || "setting.html";
      const redirect = encodeURIComponent(fileName);
      window.location.href = `login.html?redirect=${redirect}`;
      return null;
    }

    // ç™»å…¥æˆåŠŸå¾Œï¼Œæª¢æŸ¥æ˜¯å¦æœ‰è¨­å®šå­©å­ã€‚
    const hasActiveChild = await checkActiveChildAndRedirect(data.session.user);
    if (!hasActiveChild) {
        return null; // è¢«å°å‘ children.htmlï¼Œçµ‚æ­¢åŸ·è¡Œ
    }

    return data.session.user;
  }

  // é é¢åˆå§‹åŒ–æ™‚å…ˆæª¢æŸ¥
  document.addEventListener("DOMContentLoaded", async () => {
    const user = await requireAuth();
    if (!user) return;
    console.log("ç™»å…¥ä¸­çš„çˆ¸åª½ï¼š", user.id, user.email);
  });
</script>

</body>
</html>

