<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>çå‹µå°å±‹ï½œå°æ€ªç¸æŒ‘æˆ°ç‹</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      background: #FFFDF6;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      color: #C68A56;
      text-align: center;
      margin-bottom: 12px;
    }
    /* å°è¦½åˆ—æ¨£å¼ */
    .navbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .nav-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #C68A56;
      background: #FFF4C8;
      font-size: 14px;
      text-decoration: none;
      color: #5A3B24;
    }
    .nav-btn.active {
      background: #C68A56;
      color: white;
      font-weight: bold;
    }

    #points-box {
      margin: 20px 0;
      padding: 16px;
      background: #FFF4C8;
      border-radius: 12px;
      border: 2px solid #C68A56;
    }
    .reward-card {
      background: #FFFFFF;
      border: 2px solid #C68A56;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .reward-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .reward-points {
      margin-bottom: 8px;
    }
    button {
      padding: 8px 14px;
      background: #FFE680;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #FFD966;
    }
    button:disabled {
      background: #DDD;
      cursor: not-allowed;
    }
    .status {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    /* Toast */
    .toast {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 22px;
      border-radius: 20px;
      font-size: 15px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<h1>çå‹µå°å±‹ ğŸ</h1>

<!-- å°è¦½åˆ—ï¼šçµ±ä¸€å°è¦½åˆ— -->
<div class="navbar">
  <a href="index.html" class="nav-btn">é¦–é </a>
  <a href="dashboard.html" class="nav-btn">ä»Šæ—¥ä»»å‹™</a>
  <a href="setting.html" class="nav-btn">ä»»å‹™è¨­å®š</a>
  <a href="rewards.html" class="nav-btn active">çå‹µå•†åŸ</a>
  <a href="monsters.html" class="nav-btn">å°æ€ªç¸æ£®æ—</a>
  <a href="story.html" class="nav-btn">æŒ‘æˆ°ç‹æ•…äº‹</a>    
  <a href="children.html" class="nav-btn">å­©å­è³‡æ–™</a> 
</div>

<div id="points-box">
  <strong>ç›®å‰å°æ€ªç¸ï¼š</strong>
  <span id="child-display-name">è«‹é¸æ“‡å­©å­</span>
  <strong>ç›®å‰é»æ•¸ï¼š</strong>
  <span id="points">0</span> åˆ†
</div>

<div id="rewards"></div>

<!-- Toast æç¤º -->
<div id="toast" class="toast hidden">å·²å„²å­˜</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // â˜… ä¿®æ­£ï¼šçµ±ä¸€çš„ Supabase è¨­å®š
  const SUPABASE_URL = "https://reunrobejvodzkhbtspp.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJldW5yb2JlanZvZHpraGJ0c3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMzc1MDEsImV4cCI6MjA3OTgxMzUwMX0.4Tfa94upcxp2wfnBUwBtFJl7H1NdnY3uQxLRxnjBrRE";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const ACTIVE_CHILD_KEY = "monsters_active_child_id"; // å„²å­˜æ´»èºå­©å­ ID
  let currentUser = null;
  let activeChildId = null;
  let activeChildData = null; // ç•¶å‰å­©å­çš„è³‡æ–™ (åŒ…å« total_points)

  // Toast
  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.remove("hidden");
    void toast.offsetWidth; // reflow
    toast.classList.add("show");
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => {
        toast.classList.add("hidden");
      }, 300);
    }, 2000);
  }
  
  // ---- å‡è³‡æ–™ï¼šä¹‹å¾Œæœƒå¾å¾Œç«¯/è³‡æ–™åº«æŠ“ ----
  const rewards = [
    { id: 1, name: 'å†°æ·‡æ·‹ä¸€ä»½', need: 300 },
    { id: 2, name: 'Switch 30 åˆ†é˜', need: 350 },
    { id: 3, name: 'ç¡å‰æ•…äº‹æŒ‡å®šé¸ä¸€æœ¬', need: 100 },
    { id: 4, name: 'é€±æœ«é»å¿ƒ', need: 250 },
    { id: 5, name: 'çˆ¸çˆ¸é™ªç© 10 åˆ†é˜', need: 100 },
    { id: 6, name: 'çœ‹é›»è¦– 10 åˆ†é˜', need: 200 },
    { id: 7, name: 'å‡æ—¥å»å…¬åœ’ç©', need: 300 },
    { id: 8, name: 'å†’éšªé©šå–œå°ç¦®ç‰©', need: 250 },
  ];

  function updatePointsDisplay() {
      const currentPoints = activeChildData ? activeChildData.total_points : 0;
      const displayName = activeChildData ? (activeChildData.nickname || activeChildData.name) : "è«‹é¸æ“‡å­©å­";
      
      document.getElementById("points").textContent = currentPoints;
      document.getElementById("child-display-name").textContent = displayName;

      // åˆ·æ–°çå‹µåˆ—è¡¨ï¼Œå› ç‚ºé»æ•¸å¯èƒ½æ›´æ–°äº†
      renderRewards(currentPoints);
  }

  function renderRewards(currentPoints) {
    const container = document.getElementById('rewards');
    container.innerHTML = '';

    rewards.forEach(r => {
      const canRedeem = currentPoints >= r.need;
      const diff = r.need - currentPoints;

      const statusText = canRedeem
        ? 'å¯ä»¥å…Œæ› ğŸ‰'
        : `é‚„å·® ${diff} åˆ†`;

      const html = `
        <div class="reward-card">
          <div class="reward-title">${r.name}</div>
          <div class="reward-points">éœ€è¦é»æ•¸ï¼š${r.need} åˆ†</div>
          <button onclick="redeemReward(${r.id}, ${r.need})" ${canRedeem ? '' : 'disabled'}>
            ${canRedeem ? 'å…Œæ›' : 'æš«æ™‚ç„¡æ³•å…Œæ›'}
          </button>
          <div class="status">${statusText}</div>
        </div>
      `;
      container.innerHTML += html;
    });
  }

  async function redeemReward(rewardId, cost) {
    if (!currentUser || !activeChildData) {
        showToast("è«‹å…ˆé¸æ“‡å­©å­ï¼");
        return;
    }
    
    if (activeChildData.total_points < cost) {
      // TODO: æ›¿æ› alert
      alert(`é»æ•¸é‚„ä¸å¤ ï¼Œé‚„å·® ${cost - activeChildData.total_points} åˆ†å–”ï¼`);
      return;
    }

    // TODO: é€™è£¡è¦æ›æˆè‡ªè¨‚ UI æç¤ºï¼Œé¿å… alert/confirm
    const confirmRedeem = confirm(
      `ç¢ºå®šè¦å…Œæ›çå‹µå—ï¼Ÿ\né€™æœƒèŠ±è²» ${cost} åˆ†ã€‚`
    );
    if (!confirmRedeem) return;

    // 1. æ‰£é»æ•¸ä¸¦æ›´æ–° Supabase
    const newTotalPoints = activeChildData.total_points - cost;
    
    const { error } = await supabaseClient
        .from('children')
        .update({ total_points: newTotalPoints })
        .eq('id', activeChildId)
        .eq('parent_id', currentUser.id);

    if (error) {
        console.error("å…Œæ›é»æ•¸å¤±æ•—", error);
        showToast("å…Œæ›å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼");
        return;
    }

    // 2. æ›´æ–°å‰ç«¯ç‹€æ…‹
    activeChildData.total_points = newTotalPoints;
    updatePointsDisplay();
    
    // TODO: é€™è£¡è¦æ–°å¢è¨˜éŒ„å…Œæ›æ­·å²çš„é‚è¼¯
    
    showToast(`å·²å…Œæ›æˆåŠŸï¼è¨˜å¾—çµ¦å°æœ‹å‹çå‹µå–” ğŸ˜Š`);
  }

  // â˜… è¼‰å…¥ç•¶å‰å­©å­è³‡æ–™
  async function loadActiveChildData(userId, childId) {
       const { data, error } = await supabaseClient
        .from("children")
        .select("id, name, nickname, total_points, monsters_collected")
        .eq("id", childId)
        .eq("parent_id", userId)
        .single();
        
        if (error || !data) {
            console.error("è¼‰å…¥æ´»èºå­©å­è³‡æ–™å¤±æ•—", error);
            localStorage.removeItem(ACTIVE_CHILD_KEY); 
            return null;
        }
        return data;
  }

  // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦å°å‘
  async function requireAuth() {
    const { data } = await supabaseClient.auth.getSession();
    
    if (!data.session || !data.session.user) {
      // ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œå°å‘ç™»å…¥é 
      const path = window.location.pathname;
      const fileName = path.substring(path.lastIndexOf("/") + 1) || "rewards.html";
      const redirect = encodeURIComponent(fileName);
      window.location.href = `login.html?redirect=${redirect}`;
      return null;
    }
    
    currentUser = data.session.user;
    activeChildId = localStorage.getItem(ACTIVE_CHILD_KEY); // å¾ localStorage è®€å–
    
    if (!activeChildId) {
        const path = window.location.pathname;
        const fileName = path.substring(path.lastIndexOf("/") + 1) || "rewards.html";
        const redirect = encodeURIComponent(fileName);
        window.location.href = `children.html?redirect=${redirect}`;
        return null;
    }
    
    activeChildId = parseInt(activeChildId, 10);
    activeChildData = await loadActiveChildData(currentUser.id, activeChildId);
    if (!activeChildData) {
        window.location.href = `children.html`;
        return null;
    }

    return currentUser;
  }

  // åˆå§‹åŒ–ç•«é¢
  document.addEventListener("DOMContentLoaded", async () => {
    const user = await requireAuth();
    if (!user) return;
    console.log("ç™»å…¥ä¸­çš„çˆ¸åª½ï¼š", user.id, user.email);
    
    // è¼‰å…¥ä¸¦é¡¯ç¤ºé»æ•¸
    updatePointsDisplay();
  });
</script>

</body>
</html>



